{% extends "base.html" %}
{% block title %}Past Orders{% endblock %}

{% block content %}
<h1 class="display-6 p-4 text-center">View past orders</h1>
<div>
    {% if count == 0 %}
    <p class="text-center">There are no orders.</p>
    {% elif count == 1 %}
    <p class="text-center">There is 1 order.</p>
    {% else %}
    <p class="text-center">There are {{ count }} orders.</p>
    {% endif %}
</div>
<div>
    <table class="table table-striped">
    <thead>
        <tr>
            <th scope="col">Order ID</th>
            <th scope="col">Order time</th>
            <th scope="col">Stall</th>
            <th scope="col">Item</th>
            <th scope="col">Quantity</th>
            <th scope="col">Price</th>
            <th scope="col">Total</th>
            <th scope="col">Remarks</th>
            <th scope="col">Status</th>
        </tr>
    </thead>
    <tbody>
        {% for order in orders %}
        <tr>
            <td>{{ order.get_orderID }}</td>
            <td>{{ order.get_datetime }}</td>
            <td>{{ order.get_stallName }}</td>
            <td>{{ order.get_item }}</td>
            <td>{{ order.get_itemQuantity }}</td>
            <td>${{ order.get_price }}</td>
            <td>${{ order.get_total }}</td>
            <td>{{ order.get_remarks }}</td>
            <td>{{ order.get_status }}</td>
        </tr>
        </tbody>
        {% endfor %}
    </table>
    <div class="row">
        <div class="col text-right">
            <button class="btn btn-primary btnExport" onclick="return confirm('Are you sure you want to export past orders');">Export</Button>
        </div>
    </div>
    <script>
    attachEventToBtnExport()

    function attachEventToBtnExport() {
        const bntExportElement = document.querySelector( '.btnExport' )
        bntExportElement.addEventListener( 'click', exportExcel )
    }

    async function exportExcel() {
        let response = await fetch( '/download_excel_api' )
        let blobResponse = await response.blob()
        const fileName = 'PastOrders_excel.xlsx'
        downloadExcelSilently( blobResponse, fileName )
    }
    function downloadExcelSilently( blobExcelFile, filename ) {
        const url = window.URL.createObjectURL( blobExcelFile );
        const hiddenAnchor = document.createElement( "a" );
        hiddenAnchor.style.display = "none";
        hiddenAnchor.href = url;
        hiddenAnchor.download = filename;
        document.body.appendChild( hiddenAnchor );
        hiddenAnchor.click();
        window.URL.revokeObjectURL( url );
    }
    </script>
</div>
{% endblock %}